define("constants",[],function(){return{templatePrefix:"angular/templates/",allowedMediaTypes:["image"]}}),function(a,b,c){b.module("ngCookies",["ng"]).factory("$cookies",["$rootScope","$browser",function(a,d){function e(){var a,e,f,i;for(a in h)k(g[a])&&d.cookies(a,c);for(a in g)e=g[a],b.isString(e)?e!==h[a]&&(d.cookies(a,e),i=!0):b.isDefined(h[a])?g[a]=h[a]:delete g[a];if(i){i=!1,f=d.cookies();for(a in g)g[a]!==f[a]&&(k(f[a])?delete g[a]:g[a]=f[a],i=!0)}}var f,g={},h={},i=!1,j=b.copy,k=b.isUndefined;return d.addPollFn(function(){var b=d.cookies();f!=b&&(f=b,j(b,h),j(b,g),i&&a.$apply())})(),i=!0,a.$watch(e),g}]).factory("$cookieStore",["$cookies",function(a){return{get:function(c){var d=a[c];return d?b.fromJson(d):d},put:function(c,d){a[c]=b.toJson(d)},remove:function(b){delete a[b]}}}])}(window,window.angular),define("angularCookies",function(){}),angular.module("CornerCouch",["ng"]).factory("cornercouch",["$http",function(a){function b(a){return"JSONP"===a.method&&(a.params?a.params.callback="JSON_CALLBACK":a.params={callback:"JSON_CALLBACK"}),a}function c(a,b,c){var d=a;return b&&(d=d+"/"+encodeURIComponent(b)),c&&(d=d+"/"+encodeURIComponent(c)),d.replace("%2F","/")}function d(d,e,f){function h(a){g.copy(a||{},this)}var i=c(e,d);h.prototype.load=function(d,e){var h={method:f,url:c(i,d||this._id)};e&&(h.params=e);var j=this;return a(b(h)).success(function(a){g.copy(a,j)})},h.prototype.save=function(){var b;b=this._id?{method:"PUT",url:c(i,this._id)}:{method:"POST",url:i};var d=b.data=this;return a(b).success(function(a){a.id&&(d._id=a.id),a.rev&&(d._rev=a.rev)})},h.prototype.remove=function(){return a({method:"DELETE",url:c(i,this._id),params:{rev:this._rev}})},h.prototype.attach=function(b,d,e){var f=this;return g.isFunction(d)&&(e=d,d=null),a({method:"PUT",url:c(i,f._id,d||b.name),params:{rev:f._rev},headers:{"Content-Type":b.type},data:b}).success(function(){f.load().success(e||g.noop)})},h.prototype.attachMulti=function(a,b){function c(){e<a.length&&d.attach(a[e],++e<a.length?c:b)}var d=this,e=0;c()},h.prototype.detach=function(b){var d=this;return a({method:"DELETE",url:c(i,d._id,b),params:{rev:d._rev}}).success(function(){d.load()})},h.prototype.attachUri=function(a){return c(i,this._id,a)},this.docClass=h,this.uri=i,this.method=f,this.rows=[],this.prevRows=[],this.nextRow=null,this.queryActive=!1}function e(b){return b.queryActive=!0,a(b.qConfig).success(function(a,c,d,e){if(e.params&&e.params.limit&&(b.nextRow=a.rows.length===e.params.limit?a.rows.pop():null),e.append){for(var f in a.rows)b.rows.push(a.rows[f]);delete b.qConfig.append}else b.rows=a.rows;b.queryActive=!1}).error(function(){b.queryActive=!1})}function f(b,c){b?(this.uri=b,this.method=c||"JSONP","JSONP"!==this.method&&(a.defaults.withCredentials=!0)):(this.uri="",this.method="GET")}var g=angular;return d.prototype.getInfo=function(){var b=this;return a({method:"GET",url:this.uri+"/"}).success(function(a){b.info=a})},d.prototype.newDoc=function(a){return new this.docClass(a)},d.prototype.getDoc=function(a){var b=new this.docClass;return b.load(a),b},d.prototype.getQueryDoc=function(a){var b=this.rows[a];if(!b.doc)return this.getDoc(b.id);var c=b.doc;return c instanceof this.docClass?c:(c=this.newDoc(c),b.doc=c,c)},d.prototype.queryView=function(a,c){var d={method:this.method,url:this.uri+a};if(c){c.limit&&c.limit++;for(p in c)switch(p){case"key":case"keys":case"startkey":case"endkey":c[p]=g.toJson(c[p])}d.params=c}return this.qConfig=b(d),e(this)},d.prototype.query=function(a,b,c){return this.queryView("/_design/"+encodeURIComponent(a)+"/_view/"+encodeURIComponent(b),c)},d.prototype.list=function(a,b,c,d){return this.queryView("/_design/"+encodeURIComponent(a)+"/_list/"+encodeURIComponent(b)+"/"+encodeURIComponent(c),d)},d.prototype.queryAll=function(a){return this.queryView("/_all_docs",a)},d.prototype.queryRefresh=function(){return e(this)},d.prototype.queryNext=function(){var a=this.nextRow;return a&&!this.queryActive?(this.prevRows.push(this.rows[0]),this.qConfig.params.startkey=g.toJson(a.key),a.id&&a.id!==a.key&&(this.qConfig.params.startkey_docid=a.id),e(this)):null},d.prototype.queryMore=function(){var a=this.nextRow;return a&&!this.queryActive?(this.qConfig.params.startkey=g.toJson(a.key),a.id&&a.id!==a.key&&(this.qConfig.params.startkey_docid=a.id),this.qConfig.append=!0,e(this)):null},d.prototype.queryPrev=function(){var a=this.prevRows.pop();return a&&!this.queryActive?(this.qConfig.params.startkey=g.toJson(a.key),a.id&&a.id!==a.key&&(this.qConfig.params.startkey_docid=a.id),e(this)):null},f.prototype.getDB=function(a){return new d(a,this.uri,this.method)},f.prototype.getUserDB=function(){return this.userDB||(this.userDB=this.getDB("_users")),this.userDB},f.prototype.getUserDoc=function(){var a=this.getUserDB();return this.userDoc=this.userCtx.name?a.getDoc("org.couchdb.user:"+this.userCtx.name):a.newDoc(),this.userDoc},f.prototype.getInfo=function(){var b=this;return a({method:"GET",url:this.uri+"/"}).success(function(a){b.info=a})},f.prototype.getDatabases=function(){var b=this;return a({method:"GET",url:this.uri+"/_all_dbs"}).success(function(a){b.databases=a})},f.prototype.createDB=function(b){var d=this;return a({method:"PUT",url:c(d.uri,b)}).success(function(){d.databases&&d.databases.push(b)})},f.prototype.session=function(){var b=this;return a({method:"GET",url:this.uri+"/_session"}).success(function(a){b.userCtx=a.userCtx})},f.prototype.login=function(b,c){var d="name="+encodeURIComponent(b)+"&password="+encodeURIComponent(c),e=this,f=b;return a({method:"POST",url:this.uri+"/_session",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:d.replace(/%20/g,"+")}).success(function(a){delete a.ok,e.userCtx=a,e.userCtx.name=f})},f.prototype.logout=function(){var b=this;return a({method:"DELETE",url:this.uri+"/_session"}).success(function(){b.userCtx={name:null,roles:[]},b.userDoc={}})},f.prototype.getUUIDs=function(b){var c=this;return a({method:"GET",url:this.uri+"/_uuids",params:{count:b||1}}).success(function(a){c.uuids=a.uuids})},function(a,b){return new f(a,b)}}]),define("CornerCouch",function(){}),define("services/Random",[],function(){var a=angular.module("commissar.services.Random",[]);return a.factory("Random",function(){var a={getHash:function(){return Date.now()+Math.random()+""}};return a}),a}),define("services/Couch",["CornerCouch","./Random"],function(){var a=angular.module("commissar.services.Couch",["CornerCouch","ngCookies","commissar.services.Random"]);return a.factory("Couch",["$rootScope","cornercouch","$q",function(a,b,c){function d(a){return"undefined"!=typeof a}a.cornercouch||(a.cornercouch=b("/couchdb","GET"));var e={_designDocs:{commissar_validation_global:{"_design/validation_global":{_id:"_design/validation_global",language:"javascript",validate_doc_update:function(a,b,c){if(-1!==c.roles.indexOf("_admin"))return null;if(!a._deleted){if(!a.type)throw{forbidden:"All documents must have a type"};if(c.db!=="commissar_user_"+c.name&&-1===c.roles.indexOf("+admin"))throw{forbidden:"Cannot alter documents outside your own database"};if(a.created){if(String(parseInt(a.created,10))!==String(a.created))throw{forbidden:"Created timestamp must be in unix format"};if(b&&"undefined"!=typeof b.created&&a.created!==b.created)throw{forbidden:"Cannot alter created timestamp once set"}}if(a.updated&&String(parseInt(a.updated,10))!==String(a.updated))throw{forbidden:"Updated timestamp must be in unix format"}}}}},commissar_validation_users:{"_design/validation_user":{_id:"_design/validation_user",language:"javascript",validate_doc_update:function(a,b,c){if(-1!==c.roles.indexOf("_admin"))return null;if("undefined"==typeof a._id)throw{forbidden:"ID is missing"};if(!a.author&&b&&!a._deleted)throw{forbidden:"Cannot create a document without an author field"};if(a.author!==c.name&&-1===c.roles.indexOf("+admin")&&b&&!a._deleted)throw{forbidden:"Cannot forge authorship as another user"};if(0!==a._id.indexOf(a.author)&&b&&!a._deleted)throw{forbidden:"IDs must start with your username"};if(b&&b.type&&a.type!==b.type&&!a._deleted)throw{forbidden:"Cannot change the type of a document"};if(b&&b.author&&a.author!==b.author&&!a._deleted)throw{forbidden:"Cannot change the author of a document"};if(!a.author&&!b)throw{forbidden:"Cannot create a document without an author field"};if(a.author!==c.name&&-1===c.roles.indexOf("+admin")&&!b)throw{forbidden:"Cannot forge authorship as another user"};if(0!==a._id.indexOf(a.author)&&!b)throw{forbidden:"IDs must start with your username"};if(a._deleted&&b&&b.author!==c.name&&-1===c.roles.indexOf("+admin"))throw{forbidden:"Cannot delete as you are not the author"}},filters:{isPublished:function(){}}},"_design/validation_user_media":{_id:"_design/validation_user_media",language:"javascript",validate_doc_update:function(a,b,c){if(-1!==c.roles.indexOf("_admin"))return null;if("media"===a.type){if("undefined"==typeof a.title)throw{forbidden:"Media must have a title"};if("undefined"==typeof a.created)throw{forbidden:"Media must have a created timestamp"};if("undefined"!=typeof a.mediaType&&"image"!==a.mediaType)throw{forbidden:"Invalid media type"}}},views:{all:{map:function(a){"string"==typeof a.type&&"media"===a.type&&emit(null,a)}},byAuthor:{map:function(a){"string"==typeof a.type&&"media"===a.type&&emit(a.author,a)}},noThumbnails:{map:function(a){a.type&&"media"===a.type&&!a.thumbnails&&emit(null,a)}}}}}},pushDesignDocs:function(){var a=c.defer();return e.getSession().then(function(b){if(-1===b.roles.indexOf("+admin"))return a.reject("Cannot push design documents as you are not an admin"),!1;var d=[];Object.getOwnPropertyNames(e._designDocs).forEach(function(a){var b=e._designDocs[a];Object.getOwnPropertyNames(b).forEach(function(c){d.push(e.applyStaticChanges(a,b[c]))})}),c.all(d).then(function(b){a.resolve(b)},function(b){a.reject(b)})}),a.promise},stringifyFunctions:function(a){for(var b in a)a.hasOwnProperty(b)&&("function"==typeof a[b]?a[b]=""+a[b]:"object"==typeof a[b]&&(a[b]=this.stringifyFunctions(a[b])));return a},applyStaticChanges:function(a,b){var d=c.defer(),f=function(a,b){Object.getOwnPropertyNames(a).forEach(function(c){b[c]=a[c]})},g=!0,h=jQuery.extend(g,{},b);return e.stringifyFunctions(h),e.getDoc(a,h._id).then(function(a){f(h,a),a.save().then(function(){d.resolve(!0)},d.reject)},function(){e.newDoc(a).then(function(a){f(h,a),a.save().then(function(){d.resolve(!0)},d.reject)},d.reject)}),d.promise},getDoc:function(b,d){var f=c.defer();return e.databaseExists(b).then(function(c){if(c){var e=a.cornercouch.getDB(b),g=e.newDoc(),h=g.load(d);h.success(function(){f.resolve(g)}).error(f.reject)}else f.reject("Database not found: "+b)},f.reject),f.promise},saveDoc:function(a,b){var d=c.defer();return e.validateDoc(a,null,b).then(function(){e.databaseExists(b).then(function(c){c?a.save().then(d.resolve,d.reject):d.reject("Database not found: "+b)})},function(a){console.error(a),d.reject(a)}),d.promise},newDoc:function(b){var d=c.defer();return e.databaseExists(b).then(function(c){if(c){var e=a.cornercouch.getDB(b),f=e.newDoc();d.resolve(f)}else d.reject("Database not found: "+b)},d.reject),d.promise},validateDoc:function(a,b,d){var f=c.defer(),g=e._designDocs;return e.getSession().then(function(c){var e,h,i;e=jQuery.extend({},c),e.db=d;try{if(0===d.indexOf("commissar_user"))for(h in g.commissar_validation_users)i=g.commissar_validation_users[h],"function"==typeof i.validate_doc_update&&i.validate_doc_update(a,b,e);for(h in g.commissar_validation_global)i=g.commissar_validation_global[h],"function"==typeof i.validate_doc_update&&i.validate_doc_update(a,b,e)}catch(j){if("undefined"==typeof j.forbidden)throw j;f.reject(j.forbidden)}f.resolve(!0)},function(a){f.reject(a)}),f.promise},databaseExists:function(b){var e=c.defer();return d(a.cornercouch.databases)?e.resolve(a.cornercouch.databases.indexOf(b)>-1):a.cornercouch.getDatabases().then(function(){e.resolve(a.cornercouch.databases.indexOf(b)>-1)}),e.promise},getSession:function(){var b=c.defer();return"undefined"!=typeof a.cornercouch.userCtx?b.resolve(a.cornercouch.userCtx):a.cornercouch.session().then(function(){b.resolve(a.cornercouch.userCtx)},b.reject),b.promise},login:function(b,d){var e=c.defer();return a.cornercouch.login(b,d).then(function(){e.resolve(!0)},function(){e.resolve(!1)}),e.promise},logout:function(){return a.cornercouch.logout()},loggedIn:function(){var a=c.defer();return e.getSession().then(function(b){a.resolve(!(!b||!b.name))},a.reject),a.promise},hasRole:function(a){var b=c.defer();return e.loggedIn().then(function(c){c?e.getSession().then(function(c){b.resolve(c.roles.indexOf(a)>-1)}):b.resolve(!1)},b.reject),b.promise}};return e}]),a}),define("services/PostSerializer",[],function(){var a=angular.module("commissar.services.PostSerializer",[]);return a.factory("PostSerializer",function(){var a={serialize:function(a){return $.param(a)}};return a}),a}),define("services/Authentication",["angularCookies","./Couch","./PostSerializer"],function(){var a=angular.module("commissar.services.Authentication",["commissar.services.Couch","commissar.services.PostSerializer"]);return a.factory("Authentication",["Couch","$q","$http","PostSerializer","$rootScope",function(a,b,c,d,e){var f={};return f.userExists=function(c){if("undefined"==typeof c){var d=b.defer();return d.resolve(!1),d.promise}return a.databaseExists(f.getDatabaseName(c))},f.loggedIn=function(){return a.loggedIn()},f.hasRole=function(b){return a.hasRole(b)},f.isAdmin=function(){return f.hasRole("+admin")},f.getUsername=function(){var a=b.defer();return f.loggedIn().then(function(b){b?f.getSession().then(function(b){a.resolve(b.name)},a.reject):a.reject("Not logged in")},a.reject),a.promise},f.login=function(c,d){var f=b.defer();return a.login(c,d).then(function(a){f.resolve(a),e.$broadcast("AuthChange")},function(){f.resolve(!1)}),f.promise},f.register=function(a,e){var f=b.defer();return c.post("/server/register.php",d.serialize({username:a,password:e}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){f.resolve("undefined"!=typeof a.ok?!0:a.error)}).error(function(){f.resolve(!1)}),f.promise},f.getSession=function(){return a.getSession()},f.getDatabaseName=function(a){return"commissar_user_"+a.toLowerCase()},f.logout=function(){a.logout().then(function(){e.$broadcast("AuthChange")})},f}]),a}),function(){function a(a){this.tokens=[],this.tokens.links={},this.options=a||h.defaults,this.rules=i.normal,this.options.gfm&&(this.rules=this.options.tables?i.tables:i.gfm)}function b(a,b){if(this.options=b||h.defaults,this.links=a,this.rules=j.normal,!this.links)throw new Error("Tokens array requires a `links` property.");this.options.gfm?this.rules=this.options.breaks?j.breaks:j.gfm:this.options.pedantic&&(this.rules=j.pedantic)}function c(a){this.tokens=[],this.token=null,this.options=a||h.defaults}function d(a,b){return a.replace(b?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function e(a,b){return a=a.source,b=b||"",function c(d,e){return d?(e=e.source||e,e=e.replace(/(^|[^\[])\^/g,"$1"),a=a.replace(d,e),c):new RegExp(a,b)}}function f(){}function g(a){for(var b,c,d=1;d<arguments.length;d++){b=arguments[d];for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c])}return a}function h(b,e,f){if(f||"function"==typeof e){f||(f=e,e=null),e=g({},h.defaults,e||{});var i,j,k=e.highlight,l=0;try{i=a.lex(b,e)}catch(m){return f(m)}j=i.length;var n=function(){var a,b;try{a=c.parse(i,e)}catch(d){b=d}return e.highlight=k,b?f(b):f(null,a)};if(!k||k.length<3)return n();if(delete e.highlight,!j)return n();for(;l<i.length;l++)!function(a){return"code"!==a.type?--j||n():k(a.text,a.lang,function(b,c){return null==c||c===a.text?--j||n():(a.text=c,a.escaped=!0,--j||n(),void 0)})}(i[l])}else try{return e&&(e=g({},h.defaults,e)),c.parse(a.lex(b,e),e)}catch(m){if(m.message+="\nPlease report this to https://github.com/chjj/marked.",(e||h.defaults).silent)return"<p>An error occured:</p><pre>"+d(m.message+"",!0)+"</pre>";throw m}}var i={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:f,hr:/^( *[-*_]){3,} *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:f,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,blockquote:/^( *>[^\n]+(\n[^\n]+)*\n*)+/,list:/^( *)(bull) [\s\S]+?(?:hr|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment|closed|closing) *(?:\n{2,}|\s*$)/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n+|$)/,table:f,paragraph:/^((?:[^\n]+\n?(?!hr|heading|lheading|blockquote|tag|def))+)\n*/,text:/^[^\n]+/};i.bullet=/(?:[*+-]|\d+\.)/,i.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/,i.item=e(i.item,"gm")(/bull/g,i.bullet)(),i.list=e(i.list)(/bull/g,i.bullet)("hr",/\n+(?=(?: *[-*_]){3,} *(?:\n+|$))/)(),i._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|@)\\b",i.html=e(i.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,i._tag)(),i.paragraph=e(i.paragraph)("hr",i.hr)("heading",i.heading)("lheading",i.lheading)("blockquote",i.blockquote)("tag","<"+i._tag)("def",i.def)(),i.normal=g({},i),i.gfm=g({},i.normal,{fences:/^ *(`{3,}|~{3,}) *(\S+)? *\n([\s\S]+?)\s*\1 *(?:\n+|$)/,paragraph:/^/}),i.gfm.paragraph=e(i.paragraph)("(?!","(?!"+i.gfm.fences.source.replace("\\1","\\2")+"|"+i.list.source.replace("\\1","\\3")+"|")(),i.tables=g({},i.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/}),a.rules=i,a.lex=function(b,c){var d=new a(c);return d.lex(b)},a.prototype.lex=function(a){return a=a.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n"),this.token(a,!0)},a.prototype.token=function(a,b){for(var c,d,e,f,g,h,j,k,l,a=a.replace(/^ +$/gm,"");a;)if((e=this.rules.newline.exec(a))&&(a=a.substring(e[0].length),e[0].length>1&&this.tokens.push({type:"space"})),e=this.rules.code.exec(a))a=a.substring(e[0].length),e=e[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",text:this.options.pedantic?e:e.replace(/\n+$/,"")});else if(e=this.rules.fences.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"code",lang:e[2],text:e[3]});else if(e=this.rules.heading.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"heading",depth:e[1].length,text:e[2]});else if(b&&(e=this.rules.nptable.exec(a))){for(a=a.substring(e[0].length),h={type:"table",header:e[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:e[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:e[3].replace(/\n$/,"").split("\n")},k=0;k<h.align.length;k++)h.align[k]=/^ *-+: *$/.test(h.align[k])?"right":/^ *:-+: *$/.test(h.align[k])?"center":/^ *:-+ *$/.test(h.align[k])?"left":null;for(k=0;k<h.cells.length;k++)h.cells[k]=h.cells[k].split(/ *\| */);this.tokens.push(h)}else if(e=this.rules.lheading.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"heading",depth:"="===e[2]?1:2,text:e[1]});else if(e=this.rules.hr.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"hr"});else if(e=this.rules.blockquote.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"blockquote_start"}),e=e[0].replace(/^ *> ?/gm,""),this.token(e,b),this.tokens.push({type:"blockquote_end"});else if(e=this.rules.list.exec(a)){for(a=a.substring(e[0].length),f=e[2],this.tokens.push({type:"list_start",ordered:f.length>1}),e=e[0].match(this.rules.item),c=!1,l=e.length,k=0;l>k;k++)h=e[k],j=h.length,h=h.replace(/^ *([*+-]|\d+\.) +/,""),~h.indexOf("\n ")&&(j-=h.length,h=this.options.pedantic?h.replace(/^ {1,4}/gm,""):h.replace(new RegExp("^ {1,"+j+"}","gm"),"")),this.options.smartLists&&k!==l-1&&(g=i.bullet.exec(e[k+1])[0],f===g||f.length>1&&g.length>1||(a=e.slice(k+1).join("\n")+a,k=l-1)),d=c||/\n\n(?!\s*$)/.test(h),k!==l-1&&(c="\n"===h.charAt(h.length-1),d||(d=c)),this.tokens.push({type:d?"loose_item_start":"list_item_start"}),this.token(h,!1),this.tokens.push({type:"list_item_end"});this.tokens.push({type:"list_end"})}else if(e=this.rules.html.exec(a))a=a.substring(e[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:"pre"===e[1]||"script"===e[1]||"style"===e[1],text:e[0]});else if(b&&(e=this.rules.def.exec(a)))a=a.substring(e[0].length),this.tokens.links[e[1].toLowerCase()]={href:e[2],title:e[3]};else if(b&&(e=this.rules.table.exec(a))){for(a=a.substring(e[0].length),h={type:"table",header:e[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:e[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:e[3].replace(/(?: *\| *)?\n$/,"").split("\n")},k=0;k<h.align.length;k++)h.align[k]=/^ *-+: *$/.test(h.align[k])?"right":/^ *:-+: *$/.test(h.align[k])?"center":/^ *:-+ *$/.test(h.align[k])?"left":null;for(k=0;k<h.cells.length;k++)h.cells[k]=h.cells[k].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */);this.tokens.push(h)}else if(b&&(e=this.rules.paragraph.exec(a)))a=a.substring(e[0].length),this.tokens.push({type:"paragraph",text:"\n"===e[1].charAt(e[1].length-1)?e[1].slice(0,-1):e[1]});else if(e=this.rules.text.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"text",text:e[0]});else if(a)throw new Error("Infinite loop on byte: "+a.charCodeAt(0));return this.tokens};var j={escape:/^\\([\\`*{}\[\]()#+\-.!_>])/,autolink:/^<([^ >]+(@|:\/)[^ >]+)>/,url:f,tag:/^<!--[\s\S]*?-->|^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\]]*\]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^\b_((?:__|[\s\S])+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:f,text:/^[\s\S]+?(?=[\\<!\[_*`]| {2,}\n|$)/};j._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,j._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,j.link=e(j.link)("inside",j._inside)("href",j._href)(),j.reflink=e(j.reflink)("inside",j._inside)(),j.normal=g({},j),j.pedantic=g({},j.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),j.gfm=g({},j.normal,{escape:e(j.escape)("])","~|])")(),url:/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:e(j.text)("]|","~]|")("|","|https?://|")()}),j.breaks=g({},j.gfm,{br:e(j.br)("{2,}","*")(),text:e(j.gfm.text)("{2,}","*")()}),b.rules=j,b.output=function(a,c,d){var e=new b(c,d);return e.output(a)},b.prototype.output=function(a){for(var b,c,e,f,g="";a;)if(f=this.rules.escape.exec(a))a=a.substring(f[0].length),g+=f[1];else if(f=this.rules.autolink.exec(a))a=a.substring(f[0].length),"@"===f[2]?(c=":"===f[1].charAt(6)?this.mangle(f[1].substring(7)):this.mangle(f[1]),e=this.mangle("mailto:")+c):(c=d(f[1]),e=c),g+='<a href="'+e+'">'+c+"</a>";else if(f=this.rules.url.exec(a))a=a.substring(f[0].length),c=d(f[1]),e=c,g+='<a href="'+e+'">'+c+"</a>";else if(f=this.rules.tag.exec(a))a=a.substring(f[0].length),g+=this.options.sanitize?d(f[0]):f[0];else if(f=this.rules.link.exec(a))a=a.substring(f[0].length),g+=this.outputLink(f,{href:f[2],title:f[3]});else if((f=this.rules.reflink.exec(a))||(f=this.rules.nolink.exec(a))){if(a=a.substring(f[0].length),b=(f[2]||f[1]).replace(/\s+/g," "),b=this.links[b.toLowerCase()],!b||!b.href){g+=f[0].charAt(0),a=f[0].substring(1)+a;continue}g+=this.outputLink(f,b)}else if(f=this.rules.strong.exec(a))a=a.substring(f[0].length),g+="<strong>"+this.output(f[2]||f[1])+"</strong>";else if(f=this.rules.em.exec(a))a=a.substring(f[0].length),g+="<em>"+this.output(f[2]||f[1])+"</em>";else if(f=this.rules.code.exec(a))a=a.substring(f[0].length),g+="<code>"+d(f[2],!0)+"</code>";else if(f=this.rules.br.exec(a))a=a.substring(f[0].length),g+="<br>";else if(f=this.rules.del.exec(a))a=a.substring(f[0].length),g+="<del>"+this.output(f[1])+"</del>";else if(f=this.rules.text.exec(a))a=a.substring(f[0].length),g+=d(this.smartypants(f[0]));else if(a)throw new Error("Infinite loop on byte: "+a.charCodeAt(0));return g},b.prototype.outputLink=function(a,b){return"!"!==a[0].charAt(0)?'<a href="'+d(b.href)+'"'+(b.title?' title="'+d(b.title)+'"':"")+">"+this.output(a[1])+"</a>":'<img src="'+d(b.href)+'" alt="'+d(a[1])+'"'+(b.title?' title="'+d(b.title)+'"':"")+">"},b.prototype.smartypants=function(a){return this.options.smartypants?a.replace(/--/g,"—").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…"):a},b.prototype.mangle=function(a){for(var b,c="",d=a.length,e=0;d>e;e++)b=a.charCodeAt(e),Math.random()>.5&&(b="x"+b.toString(16)),c+="&#"+b+";";return c},c.parse=function(a,b){var d=new c(b);return d.parse(a)},c.prototype.parse=function(a){this.inline=new b(a.links,this.options),this.tokens=a.reverse();for(var c="";this.next();)c+=this.tok();return c},c.prototype.next=function(){return this.token=this.tokens.pop()},c.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0},c.prototype.parseText=function(){for(var a=this.token.text;"text"===this.peek().type;)a+="\n"+this.next().text;return this.inline.output(a)},c.prototype.tok=function(){switch(this.token.type){case"space":return"";case"hr":return"<hr>\n";case"heading":return"<h"+this.token.depth+' id="'+this.token.text.toLowerCase().replace(/[^\w]+/g,"-")+'">'+this.inline.output(this.token.text)+"</h"+this.token.depth+">\n";case"code":if(this.options.highlight){var a=this.options.highlight(this.token.text,this.token.lang);null!=a&&a!==this.token.text&&(this.token.escaped=!0,this.token.text=a)}return this.token.escaped||(this.token.text=d(this.token.text,!0)),"<pre><code"+(this.token.lang?' class="'+this.options.langPrefix+this.token.lang+'"':"")+">"+this.token.text+"</code></pre>\n";case"table":var b,c,e,f,g,h="";for(h+="<thead>\n<tr>\n",c=0;c<this.token.header.length;c++)b=this.inline.output(this.token.header[c]),h+="<th",this.token.align[c]&&(h+=' style="text-align:'+this.token.align[c]+'"'),h+=">"+b+"</th>\n";for(h+="</tr>\n</thead>\n",h+="<tbody>\n",c=0;c<this.token.cells.length;c++){for(e=this.token.cells[c],h+="<tr>\n",g=0;g<e.length;g++)f=this.inline.output(e[g]),h+="<td",this.token.align[g]&&(h+=' style="text-align:'+this.token.align[g]+'"'),h+=">"+f+"</td>\n";h+="</tr>\n"}return h+="</tbody>\n","<table>\n"+h+"</table>\n";case"blockquote_start":for(var h="";"blockquote_end"!==this.next().type;)h+=this.tok();return"<blockquote>\n"+h+"</blockquote>\n";case"list_start":for(var i=this.token.ordered?"ol":"ul",h="";"list_end"!==this.next().type;)h+=this.tok();return"<"+i+">\n"+h+"</"+i+">\n";case"list_item_start":for(var h="";"list_item_end"!==this.next().type;)h+="text"===this.token.type?this.parseText():this.tok();return"<li>"+h+"</li>\n";case"loose_item_start":for(var h="";"list_item_end"!==this.next().type;)h+=this.tok();return"<li>"+h+"</li>\n";case"html":return this.token.pre||this.options.pedantic?this.token.text:this.inline.output(this.token.text);case"paragraph":return"<p>"+this.inline.output(this.token.text)+"</p>\n";case"text":return"<p>"+this.parseText()+"</p>\n"}},f.exec=f,h.options=h.setOptions=function(a){return g(h.defaults,a),h},h.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1},h.Parser=c,h.parser=c.parse,h.Lexer=a,h.lexer=a.lex,h.InlineLexer=b,h.inlineLexer=b.output,h.parse=h,"object"==typeof exports?module.exports=h:"function"==typeof define&&define.amd?define("marked",[],function(){return h}):this.marked=h}.call(function(){return this||("undefined"!=typeof window?window:global)}()),define("directives/Markdown",["marked"],function(a){var b=angular.module("commissar.directives.Markdown",[]);return b.directive("markdown",function(){var b=function(b,c,d,e){var f=function(){try{var b=a(e.$modelValue);if(c.html(b),"undefined"!=typeof d.firstparagraph){var f=document.createElement("div");f.appendChild(c.find("p")[0].cloneNode(!0)),c.html(f.innerHTML)}if("undefined"!=typeof d.textonly&&c.html(c.text()),"undefined"!=typeof d.wordlimit){var g=parseInt(d.wordlimit,10),h=c.text().split(" ");if(h.length>g){for(var i=[],j=0;g>j;j++)i.push(h[j]);i.push("..."),h=i}c.html(h.join(" "))}}catch(k){}};b.$watch(d.ngModel,f),f()};return{restrict:"A",require:"ngModel",link:b}}),b}),define("filters/Capitalize",[],function(){var a=angular.module("commissar.filters.Capitalize",[]);a.filter("Capitalize",function(){return function(a){return a?a.substring(0,1).toUpperCase()+a.substring(1):null}})}),define("controllers/LogoutCtrl",["constants","../services/Authentication","../directives/Markdown","../filters/Capitalize"],function(a){var b=angular.module("commissar.controllers.LogoutCtrl",["commissar.services.Authentication"]);return b.controller("LogoutCtrl",["$scope","Authentication",function(a,b){a.name="LogoutCtrl",b.logout()}]),b.config(["$routeProvider",function(b){b.when("/logout",{templateUrl:a.templatePrefix+"logout.html",controller:"LogoutCtrl"})}]),b}),define("controllers/AdminCtrl",["constants"],function(a){var b=angular.module("commissar.controllers.AdminCtrl",["commissar.services.Authentication","commissar.directives.Markdown","commissar.filters.Capitalize"]);return b.controller("AdminCtrl",["$scope","Couch",function(a,b){a.name="AdminCtrl",a.pushDesignDocs=function(){a.pushingDesignDocs=!0,a.pushDesignDocsErrors=!1,b.pushDesignDocs().then(function(){a.pushingDesignDocs=!1},function(b){a.pushingDesignDocs=!1,a.pushDesignDocsErrors=b})},a.pushingDesignDocs=!1,a.pushDesignDocsErrors=!1}]),b.config(["$routeProvider",function(b){b.when("/admin",{templateUrl:a.templatePrefix+"admin.html",controller:"AdminCtrl"})}]),b}),define("controllers/IndexCtrl",["constants","../services/Authentication","../directives/Markdown","../filters/Capitalize"],function(a){var b=angular.module("commissar.controllers.IndexCtrl",["commissar.services.Authentication","commissar.directives.Markdown","commissar.filters.Capitalize"]);return b.controller("IndexCtrl",["$scope",function(a){a.name="IndexCtrl"}]),b.config(["$routeProvider",function(b){b.when("/",{templateUrl:a.templatePrefix+"index.html",controller:"IndexCtrl"}),b.otherwise({redirectTo:"/"})}]),b}),define("controllers/WelcomeCtrl",["constants","services/Authentication","directives/Markdown","filters/Capitalize"],function(a){var b=angular.module("commissar.controllers.WelcomeCtrl",["commissar.services.Authentication","commissar.directives.Markdown","commissar.filters.Capitalize"]);return b.controller("WelcomeCtrl",["$scope",function(a){a.name="WelcomeCtrl"}]),b.config(["$routeProvider",function(b){b.when("/welcome",{templateUrl:a.templatePrefix+"welcome.html",controller:"WelcomeCtrl"})}]),b}),define("services/ParanoidScope",[],function(){var a=angular.module("commissar.services.ParanoidScope",[]);return a.factory("ParanoidScope",function(){var a={apply:function(a,b){"undefined"==typeof b&&(b=function(){}),a.$$phase||a.$root.$$phase?b():a.$apply(b)},digest:function(a,b){"undefined"==typeof b&&(b=function(){}),a.$$phase||a.$root.$$phase?b():a.$digest(b)}};return a}),a}),define("directives/LoginForm",["constants","services/Authentication","services/ParanoidScope"],function(a){var b=angular.module("commissar.directives.LoginForm",["commissar.services.Authentication","commissar.services.ParanoidScope"]);return b.controller("commissar.directives.LoginForm.controller",["$scope","Authentication","$location","ParanoidScope","$timeout",function(a,b,c,d,e){a.name="commissar.directives.LoginForm.controller",a.loggedIn=null,a.accessDenied=!1,a.loginAttemptedRecently=!1,b.loggedIn().then(function(b){a.loggedIn=b}),a.login=function(c,d){return"undefined"==typeof c&&(c=a.loginFormUsername),"undefined"==typeof d&&(d=a.loginFormPassword),b.login(c,d).then(function(b){return a.loggedIn=!!b,a.accessDenied=!b,a.loginAttemptedRecently=!0,e(function(){a.loginAttemptedRecently=!1},1e3),b&&(a.loginFormUsername="",a.loginFormPassword=""),b})},a.userExists=function(c){return"undefined"==typeof c&&(c=a.loginFormUsername),b.userExists(c).then(function(a){return a
})},a.register=function(d,e){"undefined"==typeof d&&(d=a.loginFormUsername),"undefined"==typeof e&&(e=a.loginFormPassword);var f=b.register(d,e);return f.then(function(a){a===!0&&b.login(d,e).then(function(){c.path("/welcome")})}),f},function(){var c=null,e=null;a.isUsernameRecognised=function(f){var g=null;return"undefined"==typeof f&&(f=a.loginFormUsername),f===c?g=e:(c=f,e=!1,b.userExists(f).then(function(b){d.apply(a,function(){e=b})}),g=!1),g},a.$watch("loginFormUsername",function(){a.isUsernameRecognised()})}()}]),b.directive("loginForm",function(){var b={priority:0,templateUrl:a.templatePrefix+"directives/LoginForm.html",replace:!0,transclude:!0,restrict:"AE",scope:{},controller:"commissar.directives.LoginForm.controller"};return b}),b}),define("controllers/MenuCtrl",["services/Authentication","filters/Capitalize","directives/LoginForm","services/ParanoidScope"],function(){var a=angular.module("commissar.controllers.MenuCtrl",["commissar.services.Authentication","commissar.directives.Markdown","commissar.filters.Capitalize","commissar.directives.LoginForm","commissar.services.ParanoidScope"]);return a.controller("MenuCtrl",["$scope","Authentication","ParanoidScope","$q",function(a,b,c,d){a.name="MenuCtrl",a.loggedIn=!1,a.isAdmin=!1,a.onAuthChange=function(){d.all([b.loggedIn(),b.getSession(),b.isAdmin()]).then(function(b){a.loggedIn=b[0],a.userCtx=b[1],a.isAdmin=b[2],c.apply(a),c.digest(a)})},a.onAuthChange(),a.$on("AuthChange",a.onAuthChange),a.logout=function(){b.logout()}}]),a}),define("directives/UploadForm",["constants","services/Authentication","services/ParanoidScope","services/Couch","services/Random"],function(a){var b=angular.module("commissar.directives.UploadForm",["commissar.services.Authentication","commissar.services.ParanoidScope","commissar.services.Couch","commissar.services.Random"]);return b.controller("commissar.directives.UploadForm.controller",["$scope","$q","Couch","Authentication","Random",function(a,b,c,d,e){a.name="commissar.directives.UploadForm.controller",a.errors=[],a.valid=function(){return a.errors=[],a.uploadFormName||a.errors.push("Your masterpiece needs a title"),a.uploadFormFile||a.errors.push("You haven't selected a file to upload"),!a.errors.length},a.fileChanged=function(b,c){a.$apply(function(){a.uploadFormFile=c[0].files})},a.$on("filechanged",function(){a.fileChanged.apply(a,arguments)}),a.upload=function(){var f=b.defer();return a.valid()?d.getUsername().then(function(b){var g=d.getDatabaseName(b);c.newDoc(g).then(function(d){d._id=b+"_media_"+e.getHash(),d.author=b,d.type="media",d.mediaType="image",d.title=a.uploadFormName,d.created=Math.floor(Date.now()/1e3),c.saveDoc(d,g).then(function(){d.attach(a.uploadFormFile[0]).then(function(){f.resolve(!0)},f.reject)},f.reject)})},f.reject):f.reject("Not valid"),f.promise}}]),b.directive("uploadForm",function(){var b={priority:0,templateUrl:a.templatePrefix+"directives/UploadForm.html",replace:!0,transclude:!0,restrict:"AE",scope:{},controller:"commissar.directives.UploadForm.controller",link:function(a,b){var c=jQuery(b).find("input[type=file]");c.on("change",function(b){a.$broadcast("filechanged",c,b)})}};return b}),b}),define("filters/NotThumbnail",[],function(){var a=angular.module("commissar.filters.NotThumbnail",[]);a.filter("NotThumbnail",function(){return function(a){if(a){var b={};return angular.forEach(a,function(a,c){c.indexOf("__thumb_")<0&&(b[c]=a)}),b}return null}})}),define("directives/Media",["constants","services/Authentication","services/ParanoidScope","filters/NotThumbnail"],function(a){var b=angular.module("commissar.directives.Media",["commissar.services.Authentication","commissar.services.ParanoidScope","commissar.filters.NotThumbnail"]);return b.controller("commissar.directives.Media.controller",["$scope","NotThumbnailFilter","$element",function(b,c,d){b.name="commissar.directives.Media.controller",angular.forEach(d.find("img"),function(a){console.log(angular.element(a))}),b.className=function(){var c=b.document.mediaType;return a.allowedMediaTypes.indexOf(c)<0&&(c="",console.log("DIRTY!")),"media "+c},b.mousemove=function(a){console.log(a)},b.thumbnail=function(){var a=[];return angular.forEach(c(b.document._attachments),function(b,c){a.push(c)}),"/node/thumbnail/thumb-small/commissar_user_"+b.document.author+"/"+b.document._id+"/"+a[0]}}]),b.directive("media",function(){var b={priority:0,templateUrl:a.templatePrefix+"directives/Media.html",replace:!0,transclude:!0,restrict:"AE",require:"document",scope:{document:"=document"},controller:"commissar.directives.Media.controller"};return b}),b}),define("services/ImageManager",["./Authentication","./Couch"],function(){var a=angular.module("commissar.services.ImageManager",["commissar.services.Authentication","commissar.services.Couch"]);return a.factory("ImageManager",["Authentication","Couch","$q","$http",function(a,b,c,d){var e={};return e.getMyImages=function(){var b=c.defer();return a.getUsername().then(function(c){d.get("/couchdb/"+a.getDatabaseName(c)+"/_design/validation_user_media/_view/all").success(function(a){b.resolve(a.rows)}).error(b.reject)},b.reject),b.promise},e}]),a}),define("controllers/GalleryCtrl",["constants","directives/UploadForm","directives/Media","services/ImageManager","services/ParanoidScope","filters/NotThumbnail"],function(a){var b=angular.module("commissar.controllers.GalleryCtrl",["commissar.directives.UploadForm","commissar.directives.Media","commissar.services.ImageManager","commissar.services.ParanoidScope","commissar.filters.NotThumbnail"]);return b.controller("GalleryCtrl",["$scope","ImageManager","ParanoidScope",function(a,b,c){a.name="GalleryCtrl",b.getMyImages().then(function(b){c.apply(a,function(){a.images=b})})}]),b.config(["$routeProvider",function(b){b.when("/my/gallery",{templateUrl:a.templatePrefix+"gallery/index.html",controller:"GalleryCtrl"}),b.when("/my/gallery/upload",{templateUrl:a.templatePrefix+"gallery/upload.html",controller:"GalleryCtrl"}),b.when("/:userslug/gallery",{templateUrl:a.templatePrefix+"gallery/index.html",controller:"GalleryCtrl"})}]),b}),define("app",["controllers/LogoutCtrl","controllers/AdminCtrl","controllers/IndexCtrl","controllers/WelcomeCtrl","controllers/MenuCtrl","controllers/GalleryCtrl"],function(){var a=angular.module("commissar",["commissar.controllers.LogoutCtrl","commissar.controllers.AdminCtrl","commissar.controllers.IndexCtrl","commissar.controllers.MenuCtrl","commissar.controllers.WelcomeCtrl","commissar.controllers.GalleryCtrl"]);return a.config(["$locationProvider",function(a){a.html5Mode(!1),a.hashPrefix("!")}]),a}),function(a,b,c){function d(a){var b;if(b=a.match(j)){var c=new Date(0),d=0,f=0;return b[9]&&(d=e(b[9]+b[10]),f=e(b[9]+b[11])),c.setUTCFullYear(e(b[1]),e(b[2])-1,e(b[3])),c.setUTCHours(e(b[4]||0)-d,e(b[5]||0)-f,e(b[6]||0),e(b[7]||0)),c}return a}function e(a){return parseInt(a,10)}function f(a,b,c){var d="";for(0>a&&(d="-",a=-a),a=""+a;a.length<b;)a="0"+a;return c&&(a=a.substr(a.length-b)),d+a}function g(a,d,e){function f(a,c,d){return b.isFunction(a)?a:function(){return b.isNumber(a)?[a,c,d]:[200,a,c]}}function g(a,f,g,h,j,p,q){function r(a){return b.isString(a)||b.isFunction(a)||a instanceof RegExp?a:b.toJson(a)}function s(b){function d(){var c=b.response(a,f,g,j);t.$$respHeaders=c[2],h(o(c[0]),o(c[1]),t.getAllResponseHeaders())}function i(){for(var a=0,b=m.length;b>a;a++)if(m[a]===d){m.splice(a,1),h(-1,c,"");break}}return!e&&p&&p.then&&p.then(i),d}var t=new i,u=l[0],v=!1;if(u&&u.match(a,f)){if(!u.matchData(g))throw new Error("Expected "+u+" with different data\nEXPECTED: "+r(u.data)+"\nGOT:      "+g);if(!u.matchHeaders(j))throw new Error("Expected "+u+" with different headers\nEXPECTED: "+r(u.headers)+"\nGOT:      "+r(j));if(l.shift(),u.response)return m.push(s(u)),void 0;v=!0}for(var w,x=-1;w=k[++x];)if(w.match(a,f,g,j||{})){if(w.response)(e?e.defer:n)(s(w));else{if(!w.passThrough)throw new Error("No response defined !");d(a,f,g,h,j,p,q)}return}throw v?new Error("No response defined !"):new Error("Unexpected request: "+a+" "+f+"\n"+(u?"Expected "+u:"No more request expected"))}function j(a){b.forEach(["GET","DELETE","JSONP"],function(b){g[a+b]=function(d,e){return g[a](b,d,c,e)}}),b.forEach(["PUT","POST","PATCH"],function(b){g[a+b]=function(c,d,e){return g[a](b,c,d,e)}})}var k=[],l=[],m=[],n=b.bind(m,m.push),o=b.copy;return g.when=function(a,b,c,d){var g=new h(a,b,c,d),i={respond:function(a,b,c){g.response=f(a,b,c)}};return e&&(i.passThrough=function(){g.passThrough=!0}),k.push(g),i},j("when"),g.expect=function(a,b,c,d){var e=new h(a,b,c,d);return l.push(e),{respond:function(a,b,c){e.response=f(a,b,c)}}},j("expect"),g.flush=function(c){if(a.$digest(),!m.length)throw new Error("No pending request to flush !");if(b.isDefined(c))for(;c--;){if(!m.length)throw new Error("No more pending request to flush !");m.shift()()}else for(;m.length;)m.shift()();g.verifyNoOutstandingExpectation()},g.verifyNoOutstandingExpectation=function(){if(a.$digest(),l.length)throw new Error("Unsatisfied requests: "+l.join(", "))},g.verifyNoOutstandingRequest=function(){if(m.length)throw new Error("Unflushed requests: "+m.length)},g.resetExpectations=function(){l.length=0,m.length=0},g}function h(a,c,d,e){this.data=d,this.headers=e,this.match=function(c,d,e,f){return a!=c?!1:this.matchUrl(d)?b.isDefined(e)&&!this.matchData(e)?!1:b.isDefined(f)&&!this.matchHeaders(f)?!1:!0:!1},this.matchUrl=function(a){return c?b.isFunction(c.test)?c.test(a):c==a:!0},this.matchHeaders=function(a){return b.isUndefined(e)?!0:b.isFunction(e)?e(a):b.equals(e,a)},this.matchData=function(a){return b.isUndefined(d)?!0:d&&b.isFunction(d.test)?d.test(a):d&&b.isFunction(d)?d(a):d&&!b.isString(d)?b.equals(d,b.fromJson(a)):d==a},this.toString=function(){return a+" "+c}}function i(){i.$$lastInstance=this,this.open=function(a,b,c){this.$$method=a,this.$$url=b,this.$$async=c,this.$$reqHeaders={},this.$$respHeaders={}},this.send=function(a){this.$$data=a},this.setRequestHeader=function(a,b){this.$$reqHeaders[a]=b},this.getResponseHeader=function(a){var d=this.$$respHeaders[a];return d?d:(a=b.lowercase(a),(d=this.$$respHeaders[a])?d:(d=c,b.forEach(this.$$respHeaders,function(c,e){d||b.lowercase(e)!=a||(d=c)}),d))},this.getAllResponseHeaders=function(){var a=[];return b.forEach(this.$$respHeaders,function(b,c){a.push(c+": "+b)}),a.join("\n")},this.abort=b.noop}b.mock={},b.mock.$BrowserProvider=function(){this.$get=function(){return new b.mock.$Browser}},b.mock.$Browser=function(){var a=this;this.isMock=!0,a.$$url="http://server/",a.$$lastUrl=a.$$url,a.pollFns=[],a.$$completeOutstandingRequest=b.noop,a.$$incOutstandingRequestCount=b.noop,a.onUrlChange=function(b){return a.pollFns.push(function(){a.$$lastUrl!=a.$$url&&(a.$$lastUrl=a.$$url,b(a.$$url))}),b},a.cookieHash={},a.lastCookieHash={},a.deferredFns=[],a.deferredNextId=0,a.defer=function(b,c){return c=c||0,a.deferredFns.push({time:a.defer.now+c,fn:b,id:a.deferredNextId}),a.deferredFns.sort(function(a,b){return a.time-b.time}),a.deferredNextId++},a.defer.now=0,a.defer.cancel=function(d){var e;return b.forEach(a.deferredFns,function(a,b){a.id===d&&(e=b)}),e!==c?(a.deferredFns.splice(e,1),!0):!1},a.defer.flush=function(c){if(b.isDefined(c))a.defer.now+=c;else{if(!a.deferredFns.length)throw new Error("No deferred tasks to be flushed");a.defer.now=a.deferredFns[a.deferredFns.length-1].time}for(;a.deferredFns.length&&a.deferredFns[0].time<=a.defer.now;)a.deferredFns.shift().fn()},a.$$baseHref="",a.baseHref=function(){return this.$$baseHref}},b.mock.$Browser.prototype={poll:function(){b.forEach(this.pollFns,function(a){a()})},addPollFn:function(a){return this.pollFns.push(a),a},url:function(a){return a?(this.$$url=a,this):this.$$url},cookies:function(a,c){return a?(b.isUndefined(c)?delete this.cookieHash[a]:b.isString(c)&&c.length<=4096&&(this.cookieHash[a]=c),void 0):(b.equals(this.cookieHash,this.lastCookieHash)||(this.lastCookieHash=b.copy(this.cookieHash),this.cookieHash=b.copy(this.cookieHash)),this.cookieHash)},notifyWhenNoOutstandingRequests:function(a){a()}},b.mock.$ExceptionHandlerProvider=function(){var a;this.mode=function(b){switch(b){case"rethrow":a=function(a){throw a};break;case"log":var c=[];a=function(a){1==arguments.length?c.push(a):c.push([].slice.call(arguments,0))},a.errors=c;break;default:throw new Error("Unknown mode '"+b+"', only 'log'/'rethrow' modes are allowed!")}},this.$get=function(){return a},this.mode("rethrow")},b.mock.$LogProvider=function(){function a(a,b,c){return a.concat(Array.prototype.slice.call(b,c))}var c=!0;this.debugEnabled=function(a){return b.isDefined(a)?(c=a,this):c},this.$get=function(){var d={log:function(){d.log.logs.push(a([],arguments,0))},warn:function(){d.warn.logs.push(a([],arguments,0))},info:function(){d.info.logs.push(a([],arguments,0))},error:function(){d.error.logs.push(a([],arguments,0))},debug:function(){c&&d.debug.logs.push(a([],arguments,0))}};return d.reset=function(){d.log.logs=[],d.info.logs=[],d.warn.logs=[],d.error.logs=[],d.debug.logs=[]},d.assertEmpty=function(){var a=[];if(b.forEach(["error","warn","info","log","debug"],function(c){b.forEach(d[c].logs,function(d){b.forEach(d,function(b){a.push("MOCK $log ("+c+"): "+String(b)+"\n"+(b.stack||""))})})}),a.length)throw a.unshift("Expected $log to be empty! Either a message was logged unexpectedly, or an expected log message was not checked and removed:"),a.push(""),new Error(a.join("\n---------\n"))},d.reset(),d}},b.mock.$IntervalProvider=function(){this.$get=["$rootScope","$q",function(a,d){var e=[],f=0,g=0,h=function(h,i,j,k){function l(){if(m.notify(o++),j>0&&o>=j){var d;m.resolve(o),b.forEach(e,function(a,b){a.id===n.$$intervalId&&(d=b)}),d!==c&&e.splice(d,1)}p||a.$apply()}var m=d.defer(),n=m.promise,o=0,p=b.isDefined(k)&&!k;return j=b.isDefined(j)?j:0,n.then(null,null,h),n.$$intervalId=f,e.push({nextTime:g+i,delay:i,fn:l,id:f,deferred:m}),e.sort(function(a,b){return a.nextTime-b.nextTime}),f++,n};return h.cancel=function(a){var d;return b.forEach(e,function(b,c){b.id===a.$$intervalId&&(d=c)}),d!==c?(e[d].deferred.reject("canceled"),e.splice(d,1),!0):!1},h.flush=function(a){for(g+=a;e.length&&e[0].nextTime<=g;){var b=e[0];b.fn(),b.nextTime+=b.delay,e.sort(function(a,b){return a.nextTime-b.nextTime})}return a},h}]};var j=/^(\d{4})-?(\d\d)-?(\d\d)(?:T(\d\d)(?:\:?(\d\d)(?:\:?(\d\d)(?:\.(\d{3}))?)?)?(Z|([+-])(\d\d):?(\d\d)))?$/;b.mock.TzDate=function(a,c){var e=new Date(0);if(b.isString(c)){var g=c;if(e.origDate=d(c),c=e.origDate.getTime(),isNaN(c))throw{name:"Illegal Argument",message:"Arg '"+g+"' passed into TzDate constructor is not a valid date string"}}else e.origDate=new Date(c);var h=new Date(c).getTimezoneOffset();e.offsetDiff=60*h*1e3-1e3*a*60*60,e.date=new Date(c+e.offsetDiff),e.getTime=function(){return e.date.getTime()-e.offsetDiff},e.toLocaleDateString=function(){return e.date.toLocaleDateString()},e.getFullYear=function(){return e.date.getFullYear()},e.getMonth=function(){return e.date.getMonth()},e.getDate=function(){return e.date.getDate()},e.getHours=function(){return e.date.getHours()},e.getMinutes=function(){return e.date.getMinutes()},e.getSeconds=function(){return e.date.getSeconds()},e.getMilliseconds=function(){return e.date.getMilliseconds()},e.getTimezoneOffset=function(){return 60*a},e.getUTCFullYear=function(){return e.origDate.getUTCFullYear()},e.getUTCMonth=function(){return e.origDate.getUTCMonth()},e.getUTCDate=function(){return e.origDate.getUTCDate()},e.getUTCHours=function(){return e.origDate.getUTCHours()},e.getUTCMinutes=function(){return e.origDate.getUTCMinutes()},e.getUTCSeconds=function(){return e.origDate.getUTCSeconds()},e.getUTCMilliseconds=function(){return e.origDate.getUTCMilliseconds()},e.getDay=function(){return e.date.getDay()},e.toISOString&&(e.toISOString=function(){return f(e.origDate.getUTCFullYear(),4)+"-"+f(e.origDate.getUTCMonth()+1,2)+"-"+f(e.origDate.getUTCDate(),2)+"T"+f(e.origDate.getUTCHours(),2)+":"+f(e.origDate.getUTCMinutes(),2)+":"+f(e.origDate.getUTCSeconds(),2)+"."+f(e.origDate.getUTCMilliseconds(),3)+"Z"});var i=["getUTCDay","getYear","setDate","setFullYear","setHours","setMilliseconds","setMinutes","setMonth","setSeconds","setTime","setUTCDate","setUTCFullYear","setUTCHours","setUTCMilliseconds","setUTCMinutes","setUTCMonth","setUTCSeconds","setYear","toDateString","toGMTString","toJSON","toLocaleFormat","toLocaleString","toLocaleTimeString","toSource","toString","toTimeString","toUTCString","valueOf"];return b.forEach(i,function(a){e[a]=function(){throw new Error("Method '"+a+"' is not implemented in the TzDate mock")}}),e},b.mock.TzDate.prototype=Date.prototype;var k;try{b.module("ngAnimate"),k=!0}catch(l){}if(k&&b.module("ngAnimate").config(["$provide",function(a){var c=[];a.value("$$animateReflow",function(a){return c.push(a),b.noop}),a.decorator("$animate",function(a){return a.triggerReflow=function(){if(0===c.length)throw new Error("No animation reflows present");b.forEach(c,function(a){a()}),c=[]},a})}]),b.mock.animate=b.module("mock.animate",["ng"]).config(["$provide",function(a){a.decorator("$animate",function(a){var c={queue:[],enabled:a.enabled,flushNext:function(a){var b=c.queue.shift();if(!b)throw new Error("No animation to be flushed");if(b.method!==a)throw new Error('The next animation is not "'+a+'", but is "'+b.method+'"');return b.fn(),b}};return b.forEach(["enter","leave","move","addClass","removeClass"],function(d){c[d]=function(){var e=arguments;c.queue.push({method:d,params:e,element:b.isElement(e[0])&&e[0],parent:b.isElement(e[1])&&e[1],after:b.isElement(e[2])&&e[2],fn:function(){a[d].apply(a,e)}})}}),c})}]),b.mock.dump=function(a){function c(a){var e;return b.isElement(a)?(a=b.element(a),e=b.element("<div></div>"),b.forEach(a,function(a){e.append(b.element(a).clone())}),e=e.html()):b.isArray(a)?(e=[],b.forEach(a,function(a){e.push(c(a))}),e="[ "+e.join(", ")+" ]"):e=b.isObject(a)?b.isFunction(a.$eval)&&b.isFunction(a.$apply)?d(a):a instanceof Error?a.stack||""+a.name+": "+a.message:b.toJson(a,!0):String(a),e}function d(a,c){c=c||"  ";var e=[c+"Scope("+a.$id+"): {"];for(var f in a)Object.prototype.hasOwnProperty.call(a,f)&&!f.match(/^(\$|this)/)&&e.push("  "+f+": "+b.toJson(a[f]));for(var g=a.$$childHead;g;)e.push(d(g,c+"  ")),g=g.$$nextSibling;return e.push("}"),e.join("\n"+c)}return c(a)},b.mock.$HttpBackendProvider=function(){this.$get=["$rootScope",g]},b.mock.$TimeoutDecorator=function(a,c){function d(a){var c=[];return b.forEach(a,function(a){c.push("{id: "+a.id+", time: "+a.time+"}")}),c.join(", ")}return a.flush=function(a){c.defer.flush(a)},a.verifyNoPendingTasks=function(){if(c.deferredFns.length)throw new Error("Deferred tasks to flush ("+c.deferredFns.length+"): "+d(c.deferredFns))},a},b.mock.$RootElementProvider=function(){this.$get=function(){return b.element("<div ng-app></div>")}},b.module("ngMock",["ng"]).provider({$browser:b.mock.$BrowserProvider,$exceptionHandler:b.mock.$ExceptionHandlerProvider,$log:b.mock.$LogProvider,$interval:b.mock.$IntervalProvider,$httpBackend:b.mock.$HttpBackendProvider,$rootElement:b.mock.$RootElementProvider}).config(["$provide",function(a){a.decorator("$timeout",b.mock.$TimeoutDecorator)}]),b.module("ngMockE2E",["ng"]).config(["$provide",function(a){a.decorator("$httpBackend",b.mock.e2e.$httpBackendDecorator)}]),b.mock.e2e={},b.mock.e2e.$httpBackendDecorator=["$rootScope","$delegate","$browser",g],b.mock.clearDataCache=function(){var a,c=b.element.cache;for(a in c)if(Object.prototype.hasOwnProperty.call(c,a)){var d=c[a].handle;d&&b.element(d.elem).off(),delete c[a]}},a.jasmine||a.mocha){var m=null,n=function(){return m&&(a.mocha||m.queue.running)};beforeEach(function(){m=this}),afterEach(function(){var a=m.$injector;m.$injector=null,m.$modules=null,m=null,a&&(a.get("$rootElement").off(),a.get("$browser").pollFns.length=0),b.mock.clearDataCache(),b.forEach(b.element.fragments,function(a,c){delete b.element.fragments[c]}),i.$$lastInstance=null,b.forEach(b.callbacks,function(a,c){delete b.callbacks[c]}),b.callbacks.counter=0}),a.module=b.mock.module=function(){function a(){if(m.$injector)throw new Error("Injector already created, can not register a module!");var a=m.$modules||(m.$modules=[]);b.forEach(c,function(c){b.isObject(c)&&!b.isArray(c)?a.push(function(a){b.forEach(c,function(b,c){a.value(c,b)})}):a.push(c)})}var c=Array.prototype.slice.call(arguments,0);return n()?a():a};var o=function(a,b){this.message=a.message,this.name=a.name,a.line&&(this.line=a.line),a.sourceId&&(this.sourceId=a.sourceId),a.stack&&b&&(this.stack=a.stack+"\n"+b.stack),a.stackArray&&(this.stackArray=a.stackArray)};o.prototype.toString=Error.prototype.toString,a.inject=b.mock.inject=function(){function a(){var a=m.$modules||[];a.unshift("ngMock"),a.unshift("ng");var e=m.$injector;e||(e=m.$injector=b.injector(a));for(var f=0,g=c.length;g>f;f++)try{e.invoke(c[f]||b.noop,this)}catch(h){if(h.stack&&d)throw new o(h,d);throw h}finally{d=null}}var c=Array.prototype.slice.call(arguments,0),d=new Error("Declaration Location");return n()?a():a}}}(window,window.angular),define("angularMocks",function(){}),define("startup",["app","angularMocks"],function(a){return function(){if(window.e2emocks){console.log("RUNNING MOCKED");var b=angular.module("commissar_mocked",["commissar","ngMockE2E"]);b.run(["$httpBackend",function(a){a.whenGET("/couchdb/_all_dbs").respond(200,["_replicator","_users","commissar","commissar_user_john","commissar_validation_global","commissar_validation_users"]),a.whenPOST("/server/register.php").respond(200,{ok:!0}),a.whenGET("/couchdb/_session").respond(200,{ok:!1,userCtx:{name:null,roles:[]},info:{authentication_db:"_users",authentication_handlers:["oauth","cookie","default"]}}),a.whenPOST("/couchdb/_session").respond(200,{ok:!0,name:"a_new_username",roles:["+admin"]}),a.whenGET(/templates/).passThrough(),a.whenGET(/.*/).respond(404,"NOT SET UP IN E2EMOCKS YET")}]),a=b}var c=document.getElementsByTagName("html")[0];if(c.setAttribute("ng-app",a.name),c.dataset.ngApp=a.name,top!==window&&(top.postMessage({type:"apploaded"},"*"),console.log("Posted message!")),window.useTemplateModule){var d=angular.module("commissar_templated",[a.name]);require(["/js/templates.min.js"],function(a){a(d),angular.bootstrap(document,[d.name])})}else console.log("RUNNING WITHOUT TEMPLATE MODULE"),angular.bootstrap(document,[a.name])}});